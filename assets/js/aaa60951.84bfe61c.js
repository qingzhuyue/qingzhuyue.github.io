"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1335],{3905:(e,n,r)=>{r.d(n,{Zo:()=>u,kt:()=>g});var t=r(7294);function o(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function a(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){o(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function s(e,n){if(null==e)return{};var r,t,o=function(e,n){if(null==e)return{};var r,t,o={},i=Object.keys(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||(o[r]=e[r]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)r=i[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var l=t.createContext({}),c=function(e){var n=t.useContext(l),r=n;return e&&(r="function"==typeof e?e(n):a(a({},n),e)),r},u=function(e){var n=c(e.components);return t.createElement(l.Provider,{value:n},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},b=t.forwardRef((function(e,n){var r=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(r),b=o,g=d["".concat(l,".").concat(b)]||d[b]||p[b]||i;return r?t.createElement(g,a(a({ref:n},u),{},{components:r})):t.createElement(g,a({ref:n},u))}));function g(e,n){var r=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=r.length,a=new Array(i);a[0]=b;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[d]="string"==typeof e?e:o,a[1]=s;for(var c=2;c<i;c++)a[c]=r[c];return t.createElement.apply(null,a)}return t.createElement.apply(null,r)}b.displayName="MDXCreateElement"},2727:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var t=r(7462),o=(r(7294),r(3905));const i={sidebar_position:2,slug:"Fiber",title:"React\u6e90\u7801\uff1aFiber\u7ed3\u6784",tags:["React"]},a=void 0,s={permalink:"/react/Fiber",source:"@site/react/react202302.md",title:"React\u6e90\u7801\uff1aFiber\u7ed3\u6784",description:"\x3c!--",date:"2023-02-08T08:38:11.000Z",formattedDate:"2023\u5e742\u67088\u65e5",tags:[{label:"React",permalink:"/react/tags/react"}],readingTime:7.345,hasTruncateMarker:!1,authors:[],frontMatter:{sidebar_position:2,slug:"Fiber",title:"React\u6e90\u7801\uff1aFiber\u7ed3\u6784",tags:["React"]},prevItem:{title:"react\u6e90\u7801\uff1a\u76ee\u5f55\u7ed3\u6784\u3001\u8c03\u8bd5\u6e90\u7801",permalink:"/react/react"},nextItem:{title:"React\uff1a\u6570\u636e\u6d41",permalink:"/react/React\uff1a\u6570\u636e\u6d41"}},l={authorsImageUrls:[]},c=[{value:"Fiber\u7ed3\u6784",id:"fiber\u7ed3\u6784",level:2},{value:"\u521b\u5efaFiberRoot\u548crootFiber",id:"\u521b\u5efafiberroot\u548crootfiber",level:2},{value:"\u521b\u5efaworkInProgress Fiber",id:"\u521b\u5efaworkinprogress-fiber",level:2}],u={toc:c};function d(e){let{components:n,...r}=e;return(0,o.kt)("wrapper",(0,t.Z)({},u,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"react15\u7684\u534f\u8c03\u3010reconcile\u3011\u8fc7\u7a0b\u662f\u4e0d\u80fd\u6253\u65ad\u7684\uff0c\u90a3\u4e48\u5728\u8fdb\u884c\u5927\u91cf\u8282\u70b9\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u9020\u6210\u5361\u987f\uff0c\u56e0\u4e3a\u6d4f\u89c8\u5668\u6240\u6709\u7684\u65f6\u95f4\u90fd\u7528\u6765\u6267\u884cjs\uff0c\u800cjs\u7684\u6267\u884c\u662f\u5355\u7ebf\u7a0b\u7684\uff0c\u6240\u4ee5\u5728\u534f\u8c03\u8fc7\u7a0b\u4e2d\u5c31\u4f1a\u5361\u987f\u3002"),(0,o.kt)("p",null,"react16\u4e4b\u540e\uff0c\u6dfb\u52a0schedule\u8fc7\u7a0b\uff0c\u4e5f\u5c31\u662f\u8c03\u5ea6\u8fc7\u7a0b\uff0c\u7ed9\u6bcf\u4e00\u4e2a\u5de5\u4f5c\u5355\u5143\u4e00\u5b9a\u7684\u65f6\u95f4\uff0c\u5728\u8fd9\u4e2a\u65f6\u95f4\u5185\u6ca1\u6709\u6267\u884c\u5b8c\u6210\u7684\uff0c\u5c31\u6682\u65f6\u8df3\u51fa\u6765\u3002\u90a3\u4e48\u5f02\u6b65\u4e2d\u65ad\u7684\u66f4\u65b0\u9700\u8981\u4e00\u5b9a\u7684\u6570\u636e\u7ed3\u6784\u6765\u5b58\u50a8\u5de5\u4f5c\u5355\u5143\u7684\u4fe1\u606f\uff0c\u8fd9\u5c31\u662fFiber\u3002"),(0,o.kt)("p",null,"Fiber\u7684\u4f5c\u7528\uff1a"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u4f5c\u4e3a\u5de5\u4f5c\u5355\u5143\uff0c\u5b58\u50a8\u4e86\u8282\u70b9\u4fe1\u606f\u4ee5\u53ca\u8282\u70b9\u7684\u4f18\u5148\u7ea7\uff0c\u8fd9\u4e9b\u8282\u70b9\u901a\u8fc7\u6307\u9488\u5f62\u5f0f\u6784\u6210\u4e86Fiber\u6811\uff1b"),(0,o.kt)("li",{parentName:"ol"},"\u589e\u91cf\u6e32\u67d3\u66f4\u65b0\uff0c\u901a\u8fc7jsx\u5bf9\u8c61\u548ccurrentFiber\u5bf9\u6bd4\uff0c\u627e\u51fa\u5dee\u5f02\uff0c\u5e76\u4e14\u5e94\u7528\u5230\u771f\u5b9eDOM\u4e0a\u53bb"),(0,o.kt)("li",{parentName:"ol"},"\u6839\u636e\u8282\u70b9\u7684\u4f18\u5148\u7ea7\u6682\u505c\u3001\u7ee7\u7eed\u3001\u6392\u5e8f\u4f18\u5148\u7ea7\uff1a\u56e0\u4e3aFiber\u4e0a\u5b58\u6709\u4f18\u5148\u7ea7\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u901a\u8fc7\u4e0d\u540c\u8282\u70b9\u7684\u4f18\u5148\u7ea7\u7684\u5bf9\u6bd4\uff0c\u6765\u5b8c\u6210\u4efb\u52a1\u7684\u6682\u505c\u3001\u7ee7\u7eed\u3001\u6392\u5217\u4f18\u5148\u7ea7\uff0c\u4e3a\u4e0a\u5c42\u5b9e\u73b0\u6279\u91cf\u66f4\u65b0\u3001Suspense\u63d0\u4f9b\u57fa\u7840\uff1b"),(0,o.kt)("li",{parentName:"ol"},"\u4fdd\u5b58\u72b6\u6001\uff1aFiber\u4e0a\u6709\u72b6\u6001\u548c\u66f4\u65b0\u4fe1\u606f\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u51fd\u6570\u7ec4\u4ef6\u7684\u72b6\u6001\u66f4\u65b0\uff0c\u8fd9\u5c31\u662fhooks\u3002")),(0,o.kt)("h2",{id:"fiber\u7ed3\u6784"},"Fiber\u7ed3\u6784"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"function FiberNode(\n  tag: WorkTag,\n  pendingProps: mixed, \n  key: null | string, \n  mode: TypeOfMode, \n) {\n  // \u5b9e\u4f8b\n  this.tag = tag; // \u6807\u8bb0\u4e0d\u540c\u7684\u7ec4\u4ef6\u7c7b\u578b\n  this.key = key; // reactElement\u7684key\uff0c\u4e5f\u5c31\u662fkey\u5c5e\u6027\n  this.elementType = null; // \u5143\u7d20\u7c7b\u578b\uff0c\u662fcreateElement\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\n  this.type = null; // \u5f02\u6b65\u7ec4\u4ef6resolve\u8fd4\u56de\u7684\u5185\u5bb9\uff0c\u662ffunction\u6216\u8005class\n  this.stateNode = null; // \u771f\u5b9edom\u8282\u70b9\n\n  // Fiber\u6811\u7684\u7ed3\u6784\n  this.return = null; // \u6307\u5411\u7236\u8282\u70b9\uff0c\u5904\u7406\u5b8c\u8be5\u8282\u70b9\u540e\uff0c\u5411\u4e0a\u8fd4\u56de\n  this.child = null; // \u6307\u5411child\n  this.sibling = null; // \u6307\u5411\u5144\u5f1f\u8282\u70b9\n  this.index = 0;\n\n  this.ref = null; // ref\u5c5e\u6027\n\n  this.pendingProps = pendingProps; // \u65b0\u53d8\u52a8\u5e26\u6765\u65b0\u7684props\n  this.memoizedProps = null; // \u4e0a\u6b21\u6e32\u67d3\u540e\u7684props\n  this.updateQueue = null; // \u66f4\u65b0\u961f\u5217\u5b58\u653e\u7ec4\u4ef6\u4ea7\u751f\u7684update\n  this.memoizedState = null; // \u4e0a\u6b21\u6e32\u67d3\u7684state\n  this.dependencies = null; // \n\n  this.mode = mode; // \n\n  // Effects\n  this.flags = NoFlags;\n  this.subtreeFlags = NoFlags;\n  this.deletions = null;\n\n  //\u4f18\u5148\u7ea7\n  this.lanes = NoLanes;\n  this.childLanes = NoLanes;\n  // current\u548cworkInProgress\u7684\u6307\u9488\n  this.alternate = null;\n\n  // \u542f\u52a8\u5206\u6790\u5668\u65f6\u95f4\n  if (enableProfilerTimer) {\n    this.actualDuration = Number.NaN; // \u5b9e\u9645\u6301\u7eed\u65f6\u95f4\n    this.actualStartTime = Number.NaN; // \u5b9e\u9645\u5f00\u59cb\u65f6\u95f4\n    this.selfBaseDuration = Number.NaN; // \n    this.treeBaseDuration = Number.NaN;\n\n    this.actualDuration = 0;\n    this.actualStartTime = -1;\n    this.selfBaseDuration = 0;\n    this.treeBaseDuration = 0;\n  }\n\n  if (__DEV__) {\n    // This isn't directly used but is handy for debugging internals:\n\n    this._debugSource = null;\n    this._debugOwner = null;\n    this._debugNeedsRemount = false;\n    this._debugHookTypes = null;\n    if (!hasBadMapPolyfill && typeof Object.preventExtensions === 'function') {\n      Object.preventExtensions(this);\n    }\n  }\n}\n")),(0,o.kt)("p",null,"\u8fd9\u5c31\u662fFiber\u7684\u7ed3\u6784\u3002"),(0,o.kt)("h2",{id:"\u521b\u5efafiberroot\u548crootfiber"},"\u521b\u5efaFiberRoot\u548crootFiber"),(0,o.kt)("p",null,"Fiber\u4fdd\u5b58\u7684\u662fdom\u8282\u70b9\u4fe1\u606f\uff0c\u5f53\u524ddom\u5bf9\u5e94\u7684Fiber\u6811\u662fcurrent Fiber\uff0c\u6b63\u5728\u6784\u5efa\u7684Fiber\u6811\u662fworkInProgress Fiber\uff0c\u5b83\u662f\u5728createWorkInProgress\u4e2d\u5b8c\u6210\u3002"),(0,o.kt)("p",null,"\u9996\u6b21\u6e32\u67d3\u7684\u65f6\u5019\uff0c\u4f1a\u521b\u5efafiberRootNode\u548crootFiber\uff0cfiberRootNode\u662f\u5e94\u7528\u7684\u6839\u8282\u70b9\uff0crootFiber\u662f\uff0c\u4e4b\u540e\u6839\u636ejsx\u5bf9\u8c61\u521b\u5efaFiber\u8282\u70b9\uff0cFiber\u8282\u70b9\u8fde\u63a5\u5f62\u6210Fiber\u6811\u3002"),(0,o.kt)("p",null,"\u5148\u521b\u5efafiberRoot\uff0c\u5728ReactFiberRoot.old.js\u4e2d\u627e\u5230createFiberRoot\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5c31\u662f\u521b\u5efaFiberRoot\uff0c\u6e90\u7801\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'function createFiberRoot(\n  containerInfo: any,\n  tag: RootTag,\n  hydrate: boolean,\n  initialChildren: ReactNodeList,\n  hydrationCallbacks: null | SuspenseHydrationCallbacks,\n  isStrictMode: boolean,\n  concurrentUpdatesByDefaultOverride: null | boolean,\n  identifierPrefix: string,\n  onRecoverableError: null | ((error: mixed) => void),\n  transitionCallbacks: null | TransitionTracingCallbacks,\n): FiberRoot {\n  console.log("\u521b\u5efaFiberRootNode\u8282\u70b9")\n  const root: FiberRoot = (new FiberRootNode(\n    containerInfo,\n    tag,\n    hydrate,\n    identifierPrefix,\n    onRecoverableError,\n  ): any);\n  if (enableSuspenseCallback) {\n    root.hydrationCallbacks = hydrationCallbacks;\n  }\n\n  if (enableTransitionTracing) {\n    root.transitionCallbacks = transitionCallbacks;\n  }\n\n  const uninitializedFiber = createHostRootFiber(\n    tag,\n    isStrictMode,\n    concurrentUpdatesByDefaultOverride,\n  );\n  root.current = uninitializedFiber;\n  uninitializedFiber.stateNode = root;\n\n  if (enableCache) {\n    const initialCache = createCache();\n    retainCache(initialCache);\n\n    root.pooledCache = initialCache;\n    retainCache(initialCache);\n    const initialState: RootState = {\n      element: initialChildren,\n      isDehydrated: hydrate,\n      cache: initialCache,\n      transitions: null,\n      pendingSuspenseBoundaries: null,\n    };\n    uninitializedFiber.memoizedState = initialState;\n  } else {\n    const initialState: RootState = {\n      element: initialChildren,\n      isDehydrated: hydrate,\n      cache: (null: any), // not enabled yet\n      transitions: null,\n      pendingSuspenseBoundaries: null,\n    };\n    uninitializedFiber.memoizedState = initialState;\n  }\n\n  initializeUpdateQueue(uninitializedFiber);\n\n  return root;\n}\n')),(0,o.kt)("p",null,"\u91cc\u9762\u7684createHostRootFiber\u65b9\u6cd5\uff0c\u662f\u521b\u5efarootFiber\u7684\u3002\u5728react\u7684\u5165\u53e3\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u8c03\u7528\u7684\u662fReactDOM\u7684createRoot\u65b9\u6cd5\u3002\u8fd9\u662freact\u5e94\u7528\u9ed8\u8ba4\u7684\u5165\u53e3\u4ee3\u7801\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"import React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nconst root = ReactDOM.createRoot(document.getElementById('root'));\nroot.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n);\nreportWebVitals();\n")),(0,o.kt)("p",null,"\u5728createRoot\u65b9\u6cd5\u4e2d\uff0c\u662f\u901a\u8fc7createContainer\u65b9\u6cd5\u6765\u521b\u5efaroot\u7684\uff0c\u6e90\u7801\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"function createRoot(\n  container: Element | Document | DocumentFragment,\n  options?: CreateRootOptions,\n): RootType {\n  // \u5176\u4ed6\u4ee3\u7801\u7701\u7565\n  const root = createContainer(\n    container,\n    ConcurrentRoot,\n    null,\n    isStrictMode,\n    concurrentUpdatesByDefaultOverride,\n    identifierPrefix,\n    onRecoverableError,\n    transitionCallbacks,\n  );\n // \u5176\u4ed6\u4ee3\u7801\u7701\u7565\n  return new ReactDOMRoot(root);\n}\n")),(0,o.kt)("p",null,"\u518d\u6765\u770b\u770bcreateContainer\u7684\u6e90\u7801\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"export function createContainer(\n  containerInfo: Container,\n  tag: RootTag,\n  hydrationCallbacks: null | SuspenseHydrationCallbacks,\n  isStrictMode: boolean,\n  concurrentUpdatesByDefaultOverride: null | boolean,\n  identifierPrefix: string,\n  onRecoverableError: (error: mixed) => void,\n  transitionCallbacks: null | TransitionTracingCallbacks,\n): OpaqueRoot {\n  const hydrate = false;\n  const initialChildren = null;\n  return createFiberRoot(\n    containerInfo,\n    tag,\n    hydrate,\n    initialChildren,\n    hydrationCallbacks,\n    isStrictMode,\n    concurrentUpdatesByDefaultOverride,\n    identifierPrefix,\n    onRecoverableError,\n    transitionCallbacks,\n  );\n}\n")),(0,o.kt)("p",null,"\u8fd9\u5c31Fiber\u6700\u5f00\u59cb\u521b\u5efa\u6d41\u7a0b\u3002"),(0,o.kt)("h2",{id:"\u521b\u5efaworkinprogress-fiber"},"\u521b\u5efaworkInProgress Fiber"),(0,o.kt)("p",null,"workInProgress Fiber\uff0c\u662f\u7ec4\u4ef6\u53d1\u751f\u66f4\u65b0\u65f6\uff0c\u751f\u6210\u65b0\u7684jsx\u548ccurrent Fiber\u6811\u8fdb\u884c\u5bf9\u6bd4\u3010diff\u7b97\u6cd5\u3011\u540e\uff0c\u751f\u6210workInProgress Fiber\uff0c\u7136\u540eFiberRoot\u7684current\u6307\u5411workInProgress Fiber\uff0c\u90a3\u4e48workInProgress Fiber\u5c31\u53d8\u6210\u7684current Fiber\uff0c\u4ece\u800c\u5b8c\u6210\u66f4\u65b0\u3002\u5b8c\u6574\u6e90\u7801\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"export function createWorkInProgress(current: Fiber, pendingProps: any): Fiber {\n  let workInProgress = current.alternate;\n  if (workInProgress === null) { // \u662f\u5426\u662f\u9996\u6b21\u6e32\u67d3\u8fd8\u662f\u66f4\u65b0\u9636\u6bb5\n    workInProgress = createFiber(\n      current.tag,\n      pendingProps,\n      current.key,\n      current.mode,\n    );\n    workInProgress.elementType = current.elementType;\n    workInProgress.type = current.type;\n    workInProgress.stateNode = current.stateNode;\n\n    if (__DEV__) {\n      // DEV-only fields\n\n      workInProgress._debugSource = current._debugSource;\n      workInProgress._debugOwner = current._debugOwner;\n      workInProgress._debugHookTypes = current._debugHookTypes;\n    }\n\n    workInProgress.alternate = current;\n    current.alternate = workInProgress;\n  } else {\n    workInProgress.pendingProps = pendingProps; // \u590d\u7528\u5c5e\u6027\n    // Needed because Blocks store data on type.\n    workInProgress.type = current.type;\n    \n    workInProgress.flags = NoFlags;\n\n    // The effects are no longer valid.\n    workInProgress.subtreeFlags = NoFlags;\n    workInProgress.deletions = null;\n\n    if (enableProfilerTimer) {\n      workInProgress.actualDuration = 0;\n      workInProgress.actualStartTime = -1;\n    }\n  }\n\n  workInProgress.flags = current.flags & StaticMask;\n  workInProgress.childLanes = current.childLanes;\n  workInProgress.lanes = current.lanes;\n\n  workInProgress.child = current.child;\n  workInProgress.memoizedProps = current.memoizedProps;\n  workInProgress.memoizedState = current.memoizedState;\n  workInProgress.updateQueue = current.updateQueue;\n\n  const currentDependencies = current.dependencies;\n  workInProgress.dependencies =\n    currentDependencies === null\n      ? null\n      : {\n          lanes: currentDependencies.lanes,\n          firstContext: currentDependencies.firstContext,\n        };\n\n  // These will be overridden during the parent's reconciliation\n  workInProgress.sibling = current.sibling;\n  workInProgress.index = current.index;\n  workInProgress.ref = current.ref;\n\n  if (enableProfilerTimer) {\n    workInProgress.selfBaseDuration = current.selfBaseDuration;\n    workInProgress.treeBaseDuration = current.treeBaseDuration;\n  }\n\n  if (__DEV__) {\n    workInProgress._debugNeedsRemount = current._debugNeedsRemount;\n    switch (workInProgress.tag) {\n      case IndeterminateComponent:\n      case FunctionComponent:\n      case SimpleMemoComponent:\n        workInProgress.type = resolveFunctionForHotReloading(current.type);\n        break;\n      case ClassComponent:\n        workInProgress.type = resolveClassForHotReloading(current.type);\n        break;\n      case ForwardRef:\n        workInProgress.type = resolveForwardRefForHotReloading(current.type);\n        break;\n      default:\n        break;\n    }\n  }\n\n  return workInProgress;\n}\n")),(0,o.kt)("p",null,"\u8fd9\u5c31\u662fFiber\u6570\u636e\u7ed3\u6784\u5b8c\u6574\u6d41\u7a0b"))}d.isMDXComponent=!0}}]);